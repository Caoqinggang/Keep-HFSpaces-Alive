name: Keep Spaces Alive (API Check)

on:
  schedule:
    - cron: "0 */6 * * *" # å»ºè®®æ¯6å°æ—¶ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # æ ¼å¼å¿…é¡»æ˜¯: https://huggingface.co/spaces/ç”¨æˆ·å/é¡¹ç›®å
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets",
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      - name: Wake up and Check Status
        id: wake
        run: |
          # 1. è§£æ Space ID (ä¾‹å¦‚: tangguo1031/tgsnippets)
          SPACE_URL="${{ matrix.url }}"
          REPO_ID=$(echo "$SPACE_URL" | sed 's/https:\/\/huggingface.co\/spaces\///')
          API_URL="https://huggingface.co/api/spaces/$REPO_ID"
          
          echo "Target Space: $REPO_ID"
          
          # 2. åˆå§‹è§¦å‘ (å‘é€è¯·æ±‚ä»¥å¯åŠ¨å®¹å™¨)
          # -m 10: æœ€å¤šç­‰å¾…10ç§’ï¼Œæˆ‘ä»¬è¦çš„åªæ˜¯è§¦å‘ï¼Œä¸éœ€è¦ç­‰å®ƒåŠ è½½å®Œé¡µé¢
          echo "ğŸš€ Triggering wake-up..."
          curl -s -m 10 -A "Mozilla/5.0" "$SPACE_URL" > /dev/null || true

          # 3. å¾ªç¯æ£€æŸ¥ API çŠ¶æ€ (æœ€å¤šç­‰å¾… 5åˆ†é’Ÿ = 30æ¬¡ * 10ç§’)
          MAX_RETRIES=30
          STATUS="unknown"
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            # è°ƒç”¨ API è·å–è¿è¡Œæ—¶çŠ¶æ€
            RESPONSE=$(curl -s "$API_URL")
            # ä½¿ç”¨ jq è§£æ runtime.stage (GitHub Runner è‡ªå¸¦ jq)
            STATUS=$(echo "$RESPONSE" | jq -r '.runtime.stage')
            
            echo "Attempt $i/$MAX_RETRIES: Current Status = $STATUS"
            
            if [ "$STATUS" == "running" ]; then
              echo "âœ… Space is officially RUNNING!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # å¦‚æœæ˜¯ sleeping/stoppedï¼Œè¯´æ˜è§¦å‘æ²¡æˆåŠŸï¼Œå†æ¬¡è§¦å‘
            if [ "$STATUS" == "stopped" ] || [ "$STATUS" == "sleeping" ]; then
               echo "ğŸ”„ Space is asleep. Re-triggering..."
               curl -s -m 10 -A "Mozilla/5.0" "$SPACE_URL" > /dev/null || true
            fi

            # ç­‰å¾… 10ç§’
            sleep 10
          done

          # å¦‚æœå¾ªç¯ç»“æŸè¿˜æ²¡ runningï¼Œå°±æ˜¯å¤±è´¥
          echo "âŒ Timeout: Space failed to enter RUNNING state."
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        continue-on-error: true

      - name: Send Telegram Notification
        if: always()
        run: |
          if [ "${{ steps.wake.outputs.status }}" == "success" ]; then
            STATUS_MSG="âœ… å”¤é†’æˆåŠŸ (Running)"
          else
            STATUS_MSG="âŒ å”¤é†’å¤±è´¥/è¶…æ—¶"
          fi

          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          MESSAGE="$STATUS_MSG%0ASpace: ${{ matrix.url }}%0ATime: $TIME"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
