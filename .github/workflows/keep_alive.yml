name: Keep Spaces Alive (Direct Hit)

on:
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets",
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      - name: Wake up Space
        id: wake
        run: |
          # 1. åŸºç¡€ä¿¡æ¯è§£æ
          SPACE_URL="${{ matrix.url }}"
          # æå–ç”¨æˆ·åå’Œé¡¹ç›®å (ä¾‹å¦‚ lycc17/n8n-free)
          FULL_ID=$(echo "$SPACE_URL" | sed 's/https:\/\/huggingface.co\/spaces\///')
          USERNAME=$(echo "$FULL_ID" | cut -d'/' -f1)
          REPONAME=$(echo "$FULL_ID" | cut -d'/' -f2)
          
          # 2. æ„é€  ç›´è¿åŸŸå (Direct URL)
          # HF çš„è§„åˆ™æ˜¯: https://ç”¨æˆ·å-é¡¹ç›®å.hf.space
          # æ³¨æ„ï¼šå¦‚æœé¡¹ç›®åé‡Œæœ‰ä¸‹åˆ’çº¿ï¼Œåœ¨åŸŸåé‡Œé€šå¸¸ä¸éœ€è¦å˜ï¼Œä½†ä¸ºäº†ä¿é™©ç›´æ¥æ‹¼æ¥
          DIRECT_URL="https://${USERNAME}-${REPONAME}.hf.space"
          
          API_URL="https://huggingface.co/api/spaces/$FULL_ID"

          echo "----------------------------------------"
          echo "ğŸ¯ Target Space: $FULL_ID"
          echo "ğŸŒ Web URL:      $SPACE_URL"
          echo "ğŸ”Œ Direct URL:   $DIRECT_URL"
          echo "----------------------------------------"

          # 3. å¼ºåŠ›å”¤é†’é€»è¾‘ (The Hard Knock)
          # æˆ‘ä»¬å°è¯•å¤šç§æ–¹å¼å»â€œæ•²é—¨â€ï¼Œç¡®ä¿ Docker æ”¶åˆ°è¯·æ±‚
          
          wake_up() {
             echo "ğŸš€ Sending wake-up signals..."
             # æ–¹å¼A: è®¿é—®ä¸»é¡µ (å¸¦ Referer)
             curl -s -L -m 10 -A "Mozilla/5.0" "$SPACE_URL" -o /dev/null || true
             # æ–¹å¼B: è®¿é—®ç›´è¿åŸŸå (è¿™æ˜¯å”¤é†’ n8n çš„å…³é”®)
             curl -s -L -m 10 -A "Mozilla/5.0" "$DIRECT_URL" -o /dev/null || true
          }

          # 4. å¾ªç¯æ£€æµ‹ä¸æŒç»­å”¤é†’
          MAX_RETRIES=40 # 40æ¬¡ * 15ç§’ = 10åˆ†é’Ÿ
          FINAL_STATUS="failed"
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            # æ¯æ¬¡æ£€æµ‹å‰éƒ½å‘ä¸€æ¬¡å”¤é†’ä¿¡å·ï¼Œé˜²æ­¢ä¿¡å·ä¸¢å¤±
            wake_up

            # æŸ¥ API çŠ¶æ€
            API_RESPONSE=$(curl -s "$API_URL")
            STAGE=$(echo "$API_RESPONSE" | jq -r '.runtime.stage')

            echo "â³ Attempt $i/$MAX_RETRIES | Status: $STAGE"

            # æˆåŠŸæ¡ä»¶
            if [ "$STAGE" == "running" ]; then
              echo "âœ… Space is RUNNING!"
              FINAL_STATUS="success"
              break
            fi
            
            # å¦‚æœ API æŠ¥é”™æˆ–è€…è¿”å› null (æ¯”å¦‚ API å˜äº†)ï¼Œæˆ‘ä»¬å°è¯•é€šè¿‡ç›´è¿åŸŸåçš„ HTTP çŠ¶æ€ç å…œåº•
            if [ "$STAGE" == "null" ] || [ -z "$STAGE" ]; then
                echo "âš ï¸ API returned null. Checking HTTP status of Direct URL..."
                HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" -L -m 5 "$DIRECT_URL")
                echo "   HTTP Code: $HTTP_CODE"
                # å¦‚æœç›´è¿åŸŸåè¿”å› 200 æˆ– 401(éœ€è¦ç™»å½•ä½†å·²å¯åŠ¨)ï¼Œéƒ½ç®—æˆåŠŸ
                if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "401" ]; then
                   echo "âœ… Direct URL is responsive. Assuming Success."
                   FINAL_STATUS="success"
                   break
                fi
            fi

            sleep 15
          done

          # 5. è¾“å‡ºç»“æœ
          echo "result=$FINAL_STATUS" >> $GITHUB_OUTPUT

      - name: Send Telegram Notification
        if: always()
        run: |
          RESULT="${{ steps.wake.outputs.result }}"
          if [ "$RESULT" == "success" ]; then
            STATUS_MSG="âœ… å”¤é†’æˆåŠŸ (Running)"
          else
            STATUS_MSG="âŒ å”¤é†’å¤±è´¥ (Timeout)"
          fi

          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          MESSAGE="$STATUS_MSG%0ASpace: ${{ matrix.url }}%0ATime: $TIME"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
