name: Keep Spaces Alive with Telegram Notify

on:
  schedule:
    - cron: "0 0 * * *" # 每天运行一次
  workflow_dispatch:    # 允许手动触发

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 如果一个Space失败，不要取消其他Space的任务
      matrix:
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets", # 需要换成自己的Space的任务
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      # 1. 尝试唤醒 Space
      - name: Ping Space
        id: ping
        # -I: 只请求头信息
        # -s: 静默模式
        # --fail: 遇到 400/500 错误时返回失败代码
        # --max-time 10: 10秒超时防止卡死
        run: curl -Is --fail --max-time 10 ${{ matrix.url }}
        continue-on-error: true # 关键：即使失败也继续执行，为了发通知

      # 2. 发送 Telegram 通知
      - name: Send Telegram Notification
        if: always() # 无论上一步成功与否都执行
        run: |
          # 判断上一步的状态
          if [ "${{ steps.ping.outcome }}" == "success" ]; then
            STATUS="✅ 唤醒成功"
          else
            STATUS="❌ 唤醒失败"
          fi

          # 获取当前时间
          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          # 拼接消息内容
          MESSAGE="$STATUS%0ASpace: ${{ matrix.url }}%0ATime: $TIME"

          # 发送请求给 Telegram Bot API
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
