name: Keep Spaces Alive

on:
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets",
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      - name: Wake up and Check Status
        id: wake
        run: |
          SPACE_URL="${{ matrix.url }}"
          # æå– Space ID (å»é™¤ https å‰ç¼€)
          REPO_ID=$(echo "$SPACE_URL" | sed 's/https:\/\/huggingface.co\/spaces\///')
          API_URL="https://huggingface.co/api/spaces/$REPO_ID"
          
          echo "ğŸ¯ Target: $REPO_ID"
          echo "ğŸ”— API: $API_URL"

          # ==========================================
          # 1. å¼ºåŠ›å”¤é†’ (The Knock)
          # ==========================================
          # -L: è·Ÿéšé‡å®šå‘ (å…³é”®ä¿®å¤ï¼Œé’ˆå¯¹ n8n ç­‰åº”ç”¨)
          # -m 15: è¯·æ±‚è¶…æ—¶15ç§’ï¼Œé˜²æ­¢å¡æ­»
          echo "ğŸš€ Sending initial wake-up request..."
          curl -L -s -m 15 -A "Mozilla/5.0 Chrome/100.0" "$SPACE_URL" > /dev/null || true

          # ==========================================
          # 2. å¾ªç¯æ£€æµ‹ (The Watch) - æœ€å¤šç­‰ 10åˆ†é’Ÿ
          # ==========================================
          MAX_RETRIES=60  # 60æ¬¡
          SLEEP_SEC=10    # æ¯æ¬¡10ç§’
          FINAL_STATUS="failed"

          for ((i=1; i<=MAX_RETRIES; i++)); do
            # è·å– API çŠ¶æ€
            API_RESPONSE=$(curl -s "$API_URL")
            STAGE=$(echo "$API_RESPONSE" | jq -r '.runtime.stage')
            
            # æ‰“å°å½“å‰çŠ¶æ€ (æ–¹ä¾¿è°ƒè¯•)
            echo "Attempt $i/$MAX_RETRIES: Status = $STAGE"
            
            # åˆ¤æ–­çŠ¶æ€
            if [ "$STAGE" == "running" ]; then
              echo "âœ… Success! Space is running."
              FINAL_STATUS="success"
              break
            fi

            # å¦‚æœçŠ¶æ€æ˜¯ sleeping æˆ– stoppedï¼Œè¯´æ˜ä¹‹å‰çš„å”¤é†’æ²¡ç”Ÿæ•ˆï¼Œå†æ¬¡å‘é€è¯·æ±‚
            if [ "$STAGE" == "sleeping" ] || [ "$STAGE" == "stopped" ] || [ "$STAGE" == "paused" ]; then
               echo "ğŸ’¤ Space is still sleeping. Re-sending trigger..."
               curl -L -s -m 15 -A "Mozilla/5.0" "$SPACE_URL" > /dev/null || true
            fi
            
            # å¦‚æœæ˜¯ buildingï¼Œè¯´æ˜æ­£åœ¨åŠªåŠ›å¯åŠ¨ä¸­ï¼Œåªéœ€è¦ç­‰å¾…
            if [ "$STAGE" == "building" ] || [ "$STAGE" == "app_starting" ]; then
               echo "ğŸ—ï¸ Space is building/starting... waiting..."
            fi

            sleep $SLEEP_SEC
          done

          # ==========================================
          # 3. è®¾ç½®è¾“å‡ºå˜é‡
          # ==========================================
          echo "result=$FINAL_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$FINAL_STATUS" == "success" ]; then
            exit 0
          else
            echo "âŒ Failed to wake up space within time limit."
            # ä¸ä½¿ç”¨ exit 1ï¼Œä»¥å…æ‰“æ–­åç»­æ­¥éª¤ï¼Œç”±è¾“å‡ºå˜é‡æ§åˆ¶é€šçŸ¥
            exit 0 
          fi

      - name: Send Telegram Notification
        if: always()
        run: |
          # è·å–ä¸Šä¸€æ­¥çš„ç²¾ç¡®ç»“æœ
          RESULT="${{ steps.wake.outputs.result }}"
          
          if [ "$RESULT" == "success" ]; then
            STATUS_MSG="âœ… å”¤é†’æˆåŠŸ (Running)"
          else
            STATUS_MSG="âŒ å”¤é†’å¤±è´¥ (Timeout/Error)"
          fi

          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          MESSAGE="$STATUS_MSG%0ASpace: ${{ matrix.url }}%0ATime: $TIME"
          
          # è°ƒè¯•æ‰“å°ï¼Œç¡®ä¿ä½ èƒ½åœ¨æ—¥å¿—çœ‹åˆ°å‘é€äº†ä»€ä¹ˆ
          echo "Sending message: $MESSAGE"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
