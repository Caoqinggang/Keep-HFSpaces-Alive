name: Keep Spaces Alive
on:
  schedule:
    - cron: "0 */6 * * *" # ÊØè6Â∞èÊó∂ËøêË°å‰∏ÄÊ¨°
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets",
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      - name: Wake up Space
        id: wake
        run: |
          # ============================================
          # ‚öôÔ∏è Configuration (Âú®ËøôÈáåË∞ÉÊï¥Êó∂Èó¥)
          # ============================================
          MAX_WAIT_MINUTES=10    # ÊúÄÂ§ßÁ≠âÂæÖÊó∂Èó¥ (ÂàÜÈíü) - n8n Âª∫ËÆÆËá≥Â∞ë 10
          CHECK_INTERVAL=15      # ÊØèÊ¨°Ê£ÄÊü•Èó¥Èöî (Áßí)
          # ============================================

          # Ëá™Âä®ËÆ°ÁÆóÂæ™ÁéØÊ¨°Êï∞
          MAX_RETRIES=$((MAX_WAIT_MINUTES * 60 / CHECK_INTERVAL))
          
          SPACE_URL="${{ matrix.url }}"
          FULL_ID=$(echo "$SPACE_URL" | sed 's/https:\/\/huggingface.co\/spaces\///')
          USERNAME=$(echo "$FULL_ID" | cut -d'/' -f1)
          REPONAME=$(echo "$FULL_ID" | cut -d'/' -f2)
          DIRECT_URL="https://${USERNAME}-${REPONAME}.hf.space"
          
          echo "üéØ Target: $FULL_ID"
          echo "üîå Direct URL: $DIRECT_URL"
          echo "‚è±Ô∏è Max Wait: $MAX_WAIT_MINUTES mins ($MAX_RETRIES retries)"

          # Âî§ÈÜíÂáΩÊï∞
          trigger_wake() {
             # -m 10: 10ÁßíËøûÊé•Ë∂ÖÊó∂
             curl -s -m 10 -A "Mozilla/5.0" "$SPACE_URL" > /dev/null || true
             curl -s -m 10 -A "Mozilla/5.0" "$DIRECT_URL" > /dev/null || true
          }

          FINAL_STATUS="failed"
          START_TIME=$(date +%s)

          for ((i=1; i<=MAX_RETRIES; i++)); do
            # 1. ÂèëÈÄÅÂî§ÈÜí‰ø°Âè∑
            trigger_wake

            # 2. Ê£ÄÊµã HTTP Áä∂ÊÄÅÁ†Å (ÊúÄÂèØÈù†ÁöÑÊñπÊ≥ï)
            # -L: Ë∑üÈöèË∑≥ËΩ¨ (n8n ÂêØÂä®ÂêéÈÄöÂ∏∏‰ºöË∑≥Âà∞ /login)
            # -w: Âè™ËæìÂá∫Áä∂ÊÄÅÁ†Å
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -L -m 10 "$DIRECT_URL")
            
            # ËÆ°ÁÆóÂ∑≤ËÄóÊó∂
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))

            echo "üîÑ Attempt $i/$MAX_RETRIES (${ELAPSED}s elapsed) | HTTP Code: $CODE"

            # 3. Âà§ÂÆöÊàêÂäüÈÄªËæë
            # Âè™Ë¶ÅÁä∂ÊÄÅÁ†ÅÊòØ 200-499 ‰πãÈó¥ÔºåËØ¥ÊòéÊúçÂä°Âô®Â∑≤ÂêØÂä®Âπ∂ËÉΩÂìçÂ∫îËØ∑Ê±Ç
            # (ÊéíÈô§ 000 ËøûÊé•Â§±Ë¥• Âíå 502/503 ÊúçÂä°Êú™Â∞±Áª™)
            if [[ "$CODE" =~ ^[234] ]]; then
              echo "‚úÖ Space matches success criteria (HTTP $CODE)!"
              FINAL_STATUS="success"
              break
            fi

            sleep $CHECK_INTERVAL
          done

          echo "result=$FINAL_STATUS" >> $GITHUB_OUTPUT

      - name: Send Telegram Notification
        if: always()
        run: |
          RESULT="${{ steps.wake.outputs.result }}"
          if [ "$RESULT" == "success" ]; then
            STATUS_MSG="‚úÖ Âî§ÈÜíÊàêÂäü (Running)"
          else
            STATUS_MSG="‚ùå Âî§ÈÜíÂ§±Ë¥• (Timeout)"
          fi

          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          MESSAGE="$STATUS_MSG%0ASpace: ${{ matrix.url }}%0ATime: $TIME"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
