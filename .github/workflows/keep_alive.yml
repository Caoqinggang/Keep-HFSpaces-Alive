name: Keep Spaces Alive

on:
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        url: [
          "https://huggingface.co/spaces/tangguo1031/tgsnippets",
          "https://huggingface.co/spaces/lycc17/n8n-free"
        ]
    steps:
      - name: Wake up Space
        id: wake
        run: |
          SPACE_URL="${{ matrix.url }}"
          # 1. æå– ID å’Œæ„é€ ç›´è¿åŸŸå
          FULL_ID=$(echo "$SPACE_URL" | sed 's/https:\/\/huggingface.co\/spaces\///')
          USERNAME=$(echo "$FULL_ID" | cut -d'/' -f1)
          REPONAME=$(echo "$FULL_ID" | cut -d'/' -f2)
          
          # æ„é€ ç›´è¿åŸŸå: https://lycc17-n8n-free.hf.space
          DIRECT_URL="https://${USERNAME}-${REPONAME}.hf.space"
          API_URL="https://huggingface.co/api/spaces/$FULL_ID"

          echo "ğŸ¯ Target: $FULL_ID"
          echo "ğŸ”Œ Direct URL: $DIRECT_URL"

          # 2. å”¤é†’å‡½æ•° (åŒæ—¶è¯·æ±‚ä¸»é¡µå’Œç›´è¿åŸŸå)
          trigger_wake() {
             curl -s -m 10 -A "Mozilla/5.0" "$SPACE_URL" > /dev/null || true
             curl -s -m 10 -A "Mozilla/5.0" "$DIRECT_URL" > /dev/null || true
          }

          # 3. å¾ªç¯æ£€æµ‹ (å®½æ¾æ¨¡å¼)
          MAX_RETRIES=40
          FINAL_STATUS="failed"

          for ((i=1; i<=MAX_RETRIES; i++)); do
            # æ¯ä¸€è½®éƒ½å°è¯•è§¦å‘ï¼Œç¡®ä¿æ²¡ç¡è¿‡å»
            trigger_wake

            # --- æ£€æµ‹æ–¹å¼ A: API çŠ¶æ€ (ä½œä¸ºå‚è€ƒ) ---
            API_RESPONSE=$(curl -s "$API_URL")
            STAGE=$(echo "$API_RESPONSE" | jq -r '.runtime.stage')
            
            # --- æ£€æµ‹æ–¹å¼ B: HTTP çŠ¶æ€ç  (ä½œä¸ºæœ€ç»ˆä¾æ®) ---
            # -w "%{http_code}" ä»…è¾“å‡ºçŠ¶æ€ç 
            # -o /dev/null ä¸¢å¼ƒå“åº”ä½“
            # æ³¨æ„ï¼šè¿™é‡Œä¸åŠ  -Lï¼Œæˆ‘ä»¬è¦çœ‹åŸå§‹çŠ¶æ€ç 
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "$DIRECT_URL")

            echo "â³ Try $i: API='$STAGE' | HTTP_CODE='$HTTP_CODE'"

            # === åˆ¤å®šæˆåŠŸçš„æ ¸å¿ƒé€»è¾‘ ===
            # 1. å¦‚æœ API æ˜ç¡®è¯´æ˜¯ running -> æˆåŠŸ
            if [ "$STAGE" == "running" ]; then
              echo "âœ… Detected RUNNING via API!"
              FINAL_STATUS="success"
              break
            fi

            # 2. å¦‚æœ HTTP çŠ¶æ€ç æ˜¯ 200-499 ä¹‹é—´ï¼Œè¯´æ˜æœåŠ¡å™¨å·²ç»å“åº”äº† -> æˆåŠŸ
            #    HF å¯åŠ¨ä¸­é€šå¸¸è¿”å› 503 æˆ– 000(è¶…æ—¶)ï¼Œæ‰€ä»¥åªè¦ä¸æ˜¯ 5xxï¼Œå°±æ˜¯é†’äº†
            if [[ "$HTTP_CODE" =~ ^[234] ]]; then
              echo "âœ… Detected HTTP $HTTP_CODE (Server is responsive)!"
              FINAL_STATUS="success"
              break
            fi

            # 3. ç‰¹æ®Šæƒ…å†µï¼šn8n æœ‰æ—¶ä¼šè¿”å› 502 Bad Gateway ä¸€å°ä¼šå„¿ç„¶åæ‰å¥½
            #    æ‰€ä»¥æˆ‘ä»¬ç»§ç»­å¾ªç¯ç­‰å¾…
            
            sleep 15
          done

          echo "result=$FINAL_STATUS" >> $GITHUB_OUTPUT

      - name: Send Telegram Notification
        if: always()
        run: |
          RESULT="${{ steps.wake.outputs.result }}"
          if [ "$RESULT" == "success" ]; then
            STATUS_MSG="âœ… å”¤é†’æˆåŠŸ"
          else
            STATUS_MSG="âŒ å”¤é†’å¤±è´¥/è¶…æ—¶"
          fi

          TIME=$(date "+%Y-%m-%d %H:%M:%S")
          MESSAGE="$STATUS_MSG%0ASpace: ${{ matrix.url }}%0ATime: $TIME"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_ID }}" \
          -d text="$MESSAGE"
